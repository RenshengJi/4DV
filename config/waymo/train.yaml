# Stage 1 Online Training Configuration for VGGT
# 第一阶段在线训练配置 - 包含统一的损失权重管理

# debug: true

# =============== 模型配置 ===============
model: "VGGT(img_size=518, patch_size=14, embed_dim=1024, sh_degree=0, use_gs_head=True, use_gs_head_velocity=True, use_gs_head_segment=False, use_gt_camera=True, velocity_head_small_init=False)"
# sh_degree: 球谐函数的阶数（0=只有DC分量3个参数，1=DC+方向性12个参数，2=27个参数，3=48个参数）
# use_gs_head: 是否对gaussian_head使用DPTGSHead (True=DPTGSHead, False=DPTHead)
#   - True: gaussian_head使用DPTGSHead (默认)
#   - False: gaussian_head使用普通DPTHead
# use_gs_head_velocity: 是否对velocity_head使用DPTGSHead (True=DPTGSHead, False=DPTHead)
#   - True: velocity_head使用DPTGSHead
#   - False: velocity_head使用普通DPTHead (默认)
# use_gs_head_segment: 是否对segment_head使用DPTGSHead (True=DPTGSHead, False=DPTHead)
#   - True: segment_head使用DPTGSHead
#   - False: segment_head使用普通DPTHead (默认)
# Gaussian head的output_dim会根据sh_degree自动计算：11 + 3*(sh_degree+1)^2
# use_gt_camera: 是否在模型forward中使用GT相机参数来计算world_points
#   - True: 使用GT的extrinsics和intrinsics
#   - False: 使用模型预测的pose_enc (默认)
# velocity_head_small_init: 是否对velocity_head最后一层进行小初始化
#   - True: 最后一层weight初始化为小值(std=0.001)，bias初始化为0，使velocity从接近0开始
#   - False: 使用默认初始化 (默认)

# pretrained: model.pt
# pretrained_velocity: False
pretrained_velocity: "checkpoints/new/start/checkpoint-epoch_0_19533.pth"

# VGGT冻结策略配置
# 可选值: "none", "noap",
# null表示不设置冻结策略（保持模型默认行为）
vggt_freeze_strategy: "none"


# =============== 辅助模型配置 ===============
auxiliary_models:
  # # DAM2模型 (用于生成sky masks)
  # dam2: DepthAnythingV2(encoder="vitb", offload=${offload_auxiliary})

offload_auxiliary: False

# =============== 训练配置 ===============
load_only_encoder: False
long_context: True
fixed_length: False
resume: null
benchmark: False
num_views: 4
num_test_views: 16

# =============== 第一阶段损失权重配置 ===============
# 权重为0则完全不计算该损失

# Self Render Loss (训练gaussian head)
self_render_weight: 0.0                    # Gaussian参数学习的主要损失
self_render_rgb_weight: 1.0                # RGB损失权重
self_render_lpips_weight: 0.0              # LPIPS感知损失权重
self_render_depth_weight: 0.0              # 深度损失权重

# GT Flow Loss Ours (我们自己实现的版本)
gt_flow_loss_ours_weight: 1.0              # 自定义GT flowmap损失权重

# Sky Opacity Loss (监督gaussian head的opacity参数)
sky_opacity_weight: 0.0                    # 天空区域opacity约束

# Velocity Regularization Loss (约束velocity值)
velocity_reg_weight: 0.0                 # 速度正则化约束

# Segmentation Loss (监督segment head训练)
segment_loss_weight: 1.0                  # 语义分割损失权重 (从flowmap第4维度提取GT labels)
                                          # 4类: bg(0), vehicle(1), sign(2), pedestrian+cyclist(3)

# Camera Loss (监督camera head训练)
camera_loss_weight: 5.0                   # 相机参数预测损失权重

# Depth Loss (监督depth head训练)
conf_depth_loss_weight: 1.0                    # 深度预测损失权重
grad_depth_loss_weight: 0.0                 # 深度梯度损失权重
reg_depth_loss_weight: 1.0                      # 深度正则化损失权重

# Scale Loss (监督scale head训练，使用depth_scale_factor作为GT)
scale_loss_weight: 1.0                      # 场景尺度预测损失权重

# Aggregator_all Render Loss (代替Stage2 refine网络的渲染loss)
# 这个loss直接在Stage1中使用动态物体处理+渲染监督,跳过Stage2的refine网络
aggregator_all_start_iter: 0           # Aggregator_all loss开始计算的iteration (默认50k)
aggregator_all_render_rgb_weight: 1.0      # Aggregator_all RGB渲染损失权重
aggregator_all_render_depth_weight: 1.0    # Aggregator_all depth渲染损失权重
aggregator_all_render_lpips_weight: 0.1    # Aggregator_all LPIPS渲染损失权重
aggregator_all_detach_velocity: false      # 是否detach velocity阻止梯度回传到velocity head
                                           # true: velocity.detach()不回传梯度，只用velocity监督dynamic objects
                                           # false: 允许渲染loss梯度回传到velocity head (默认)
# Stage2配置（用于aggregator_all loss的渲染配置）
stage2_render_only_dynamic: false          # 是否只渲染动态物体
stage2_supervise_only_dynamic: false       # 是否只监督动态区域

# 渲染配置（用于self_render_loss和aggregator_all_loss）
enable_voxel_pruning: true                 # 是否启用voxel剪枝
voxel_size: 0.002                          # voxel大小（metric尺度，单位米）

# 动态处理器配置（用于aggregator_all loss的动态物体处理）
min_object_size: 500                       # 最小物体尺寸（点数）
max_objects_per_frame: 10                  # 每帧最大物体数量
velocity_threshold: 0.1                    # 速度阈值（metric尺度，m/s）
clustering_eps: 0.3                       # DBSCAN邻域半径
clustering_min_samples: 10                 # DBSCAN最小样本数
tracking_position_threshold: 2.0           # 位置匹配阈值
tracking_velocity_threshold: 0.2           # 速度匹配阈值
enable_optical_flow_aggregation: true      # 是否使用光流聚合
use_velocity_based_transform: true        # 是否使用velocity直接计算变换（false=光流方法，true=velocity方法）
velocity_transform_mode: "procrustes"          # velocity变换模式: "simple"(仅T)或"procrustes"(R+T)

# =============== 数据集配置 ===============

train_dataset: 2 * Waymo_Multi(
  ROOT="../data/waymo/train_full",
  valid_camera_id_list=["1", "2", "3"],
  intervals=[1],
  resolution=[(518, 336)], transform=ImgNorm,
  num_views=${num_views}, zero_ground_velocity=True,
  multi_camera_mode=True)  # New: set to True to enable multi-camera mode

test_dataset: 1000 @ Waymo_Multi(
  ROOT="../data/waymo/train_full",
  valid_camera_id_list=["1", "2", "3"],
  intervals=[1],
  resolution=[(518, 378),(518, 336),(518, 294),(518, 252),(518, 210),(518, 140),(378, 518),(336, 518),(294, 518),(252, 518)], num_views=${num_test_views}, seed=42, zero_ground_velocity=True,
  multi_camera_mode=True)  # New: set to True to enable multi-camera mode

# =============== 优化器配置 ===============
seed: 0
batch_size: 1
accum_iter: 4
gradient_checkpointing: True
epochs: 1
start_epoch: 0
weight_decay: 0.05
lr: 1e-4
min_lr: 1e-8
warmup_epochs: 0.02
amp: 1

# =============== 训练监控配置 ===============
num_workers: 4
world_size: 1
local-rank: -1
dist_url: 'env://'
rank: 0
gpu: 0
distributed: False
dist_backend: 'nccl'

eval_freq: 1
save_freq: 0.05                             # 每10%的epoch保存一次
keep_freq: 2
print_freq: 10
print_img_freq: 50000000
num_imgs_vis: 4

# =============== 输出配置 ===============
save_dir: 'checkpoints/new'
# exp_name: 'aggregator_from_scratch'
exp_name: 'start'
task: 'cut3r'
logdir: ./${save_dir}/${exp_name}/logs
output_dir: ./${save_dir}/${exp_name}/

# =============== Hydra配置 ===============
hydra:
  verbose: False
  run:
    dir: ./${save_dir}/${exp_name}